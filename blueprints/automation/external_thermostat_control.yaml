blueprint:
  name: External Thermostat Control v1.1
  source_url: https://raw.githubusercontent.com/jcspenle/HA_SensorPilotWire/main/blueprints/automation/jcspenle/external_thermostat_control_light.yaml
  description: >
    Thermostat virtuel utilisant une sonde de temp√©rature externe pour contr√¥ler un chauffage fil pilote.
    
    **Version Light** : G√®re UNIQUEMENT la r√©gulation de temp√©rature.
    Compatible avec le blueprint fen√™tres/portes (s√©paration des responsabilit√©s).
    
    Fonctionnalit√©s :
    - Compatible Climate Entity (Zigbee/Z-Wave) et Select Fil Pilote (NodOn)
    - Hyst√©r√©sis configurable (0.5¬∞C recommand√© pour radiateurs fonte)
    - Consigne de temp√©rature ajustable via input_number
    - Activation/d√©sactivation manuelle via input_boolean
    - Mode de chauffage configurable (comfort, eco, etc.)
    - Logs optionnels pour le suivi
    
    Note : Les fen√™tres/portes doivent √™tre g√©r√©es par le blueprint s√©par√© "Heating Control - Window/Door Open Detection"
    pour √©viter les conflits et assurer une architecture claire.
  domain: automation

  input:
    # === CONFIGURATION PRINCIPALE ===
    thermostat_active:
      name: Activation du thermostat
      description: Input boolean pour activer/d√©sactiver le thermostat. Quand d√©sactiv√©, le chauffage est forc√© √† OFF.
      selector:
        entity:
          domain: input_boolean

    temperature_sensor:
      name: Capteur de temp√©rature
      description: Sonde de temp√©rature externe √† utiliser pour la r√©gulation (diff√©rente de celle du chauffage)
      selector:
        entity:
          domain: sensor
          device_class: temperature

    temperature_setpoint:
      name: Consigne de temp√©rature
      description: Input number contenant la temp√©rature cible souhait√©e
      selector:
        entity:
          domain: input_number

    hysteresis:
      name: Hyst√©r√©sis
      description: √âcart de temp√©rature pour √©viter les cycles rapides ON/OFF. Recommandation 0.5¬∞C pour radiateurs fonte (bonne inertie).
      selector:
        number:
          min: 0.1
          max: 2.0
          step: 0.1
          unit_of_measurement: "¬∞C"
      default: 0.5

    # === MODULE DE CHAUFFAGE ===
    module_type:
      name: Type de module chauffage
      description: "Climate: entit√© climate (Zigbee/Z-Wave/WiFi) | Select: entit√© select fil pilote (NodOn)"
      selector:
        select:
          options: ["Climate", "Select"]
      default: "Select"

    heating_entity_climate:
      name: Entit√© de chauffage (Climate)
      description: "S√©lectionner l'entit√© climate si type Climate (laisser vide si type Select)"
      selector:
        entity:
          domain: climate
      default: ""

    heating_entity_select:
      name: Entit√© de chauffage (Select Fil Pilote)
      description: "S√©lectionner l'entit√© select fil pilote si type Select/NodOn (laisser vide si type Climate)"
      selector:
        entity:
          domain: select
      default: ""

    heating_mode:
      name: Mode de chauffage actif
      description: Mode √† utiliser quand le chauffage doit √™tre actif (temp√©rature trop basse)
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco"]
      default: "comfort"

    # === NOTIFICATIONS & LOGS ===
    room_name:
      name: Nom de la pi√®ce
      description: Nom de la pi√®ce pour l'identification dans les logs
      selector:
        text: {}
      default: "Pi√®ce"

    log_entity:
      name: Entit√© de log (optionnel)
      description: Input_text pour logger l'activit√© du thermostat. Laisser vide pour d√©sactiver les logs.
      selector:
        entity:
          domain: input_text
      default: ""

# ===== VARIABLES =====
variables:
  active: !input thermostat_active
  temp_sensor: !input temperature_sensor
  setpoint: !input temperature_setpoint
  hyst: !input hysteresis
  module_type: !input module_type
  heating_entity_climate: !input heating_entity_climate
  heating_entity_select: !input heating_entity_select
  heating_entity: >
    {{ heating_entity_climate if module_type == 'Climate' else heating_entity_select }}
  heating_mode: !input heating_mode
  room: !input room_name
  log_ent: !input log_entity
  
  # Temp√©rature actuelle et consigne
  current_temp: >
    {{ states(temp_sensor) | float(0) }}
  target_temp: >
    {{ states(setpoint) | float(19) }}
  
  # Mode actuel du chauffage
  current_mode: >
    {% if module_type == 'Select' %}
      {{ states(heating_entity) }}
    {% else %}
      {{ state_attr(heating_entity, 'preset_mode') }}
    {% endif %}
  
  # Mapper les modes pour NodOn (comfort-1 ‚Üí comfort_-1)
  heating_mode_mapped: >
    {% set mode = heating_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}

# ===== TRIGGERS =====
trigger:
  # Changement de temp√©rature
  - platform: state
    entity_id: !input temperature_sensor
    id: temp_change
  
  # Changement de consigne
  - platform: state
    entity_id: !input temperature_setpoint
    id: setpoint_change
  
  # Activation/d√©sactivation manuelle
  - platform: state
    entity_id: !input thermostat_active
    id: active_change

# ===== CONDITIONS =====
condition: []

# ===== ACTIONS =====
action:
  - choose:
      # === THERMOSTAT D√âSACTIV√â ===
      - conditions:
          - condition: template
            value_template: "{{ is_state(active, 'off') }}"
        sequence:
          # Si le chauffage est actuellement actif, le couper
          - choose:
              # MODULE SELECT (NodOn)
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Select' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "off"
              
              # MODULE CLIMATE
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Climate' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: "{{ heating_entity }}"
          
          # Log de d√©sactivation
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: "{{ now().strftime('%H:%M') }} - {{ room }}: ‚è∏Ô∏è Thermostat D√âSACTIV√â"

      # === R√âGULATION NORMALE (Thermostat actif) ===
      - conditions:
          - condition: template
            value_template: "{{ is_state(active, 'on') }}"
        sequence:
          - choose:
              # === TEMP√âRATURE TROP BASSE ‚Üí CHAUFFER ===
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp < (target_temp - hyst) }}"
                sequence:
                  # Activer le chauffage selon le type de module
                  - choose:
                      # MODULE SELECT (NodOn)
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Select' }}"
                          - condition: template
                            value_template: "{{ current_mode != heating_mode_mapped }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ heating_mode_mapped }}"
                          
                          # Log activation
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: üî• Chauffage ON ({{ current_temp | round(1) }}¬∞C < {{ (target_temp - hyst) | round(1) }}¬∞C)
                      
                      # MODULE CLIMATE
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Climate' }}"
                          - condition: template
                            value_template: "{{ current_mode != heating_mode }}"
                        sequence:
                          - service: climate.turn_on
                            target:
                              entity_id: "{{ heating_entity }}"
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ heating_mode }}"
                          
                          # Log activation
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: üî• Chauffage ON ({{ current_temp | round(1) }}¬∞C < {{ (target_temp - hyst) | round(1) }}¬∞C)

              # === TEMP√âRATURE TROP HAUTE ‚Üí COUPER ===
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp > (target_temp + hyst) }}"
                sequence:
                  # Couper le chauffage selon le type de module
                  - choose:
                      # MODULE SELECT (NodOn)
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Select' }}"
                          - condition: template
                            value_template: "{{ current_mode not in ['off', 'none'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "off"
                          
                          # Log d√©sactivation
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: ‚ùÑÔ∏è Chauffage OFF ({{ current_temp | round(1) }}¬∞C > {{ (target_temp + hyst) | round(1) }}¬∞C)
                      
                      # MODULE CLIMATE
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Climate' }}"
                          - condition: template
                            value_template: "{{ current_mode not in ['off', 'none'] }}"
                        sequence:
                          - service: climate.turn_off
                            target:
                              entity_id: "{{ heating_entity }}"
                          
                          # Log d√©sactivation
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: ‚ùÑÔ∏è Chauffage OFF ({{ current_temp | round(1) }}¬∞C > {{ (target_temp + hyst) | round(1) }}¬∞C)

              # === ZONE MORTE (entre target-hyst et target+hyst) ===
              # Pas d'action, on laisse le chauffage dans son √©tat actuel pour √©viter les cycles rapides

mode: queued
max: 10
