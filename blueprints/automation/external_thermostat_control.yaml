blueprint:
  name: External Thermostat Control v1.0.1
  source_url: https://raw.githubusercontent.com/jcspenle/HA_SensorPilotWire/main/blueprints/automation/jcspenle/external_thermostat_control.yaml
  description: >
    Thermostat virtuel utilisant une sonde de tempÃ©rature externe pour contrÃ´ler un chauffage fil pilote.
    - Compatible Climate Entity (Zigbee/Z-Wave) et Select Fil Pilote (NodOn)
    - HystÃ©rÃ©sis configurable (recommandÃ© 0.5Â°C pour radiateurs fonte)
    - Consigne de tempÃ©rature ajustable
    - IntÃ©gration avec blueprint fenÃªtres/portes
    - Activation/dÃ©sactivation manuelle
    - Mode de chauffage configurable
  domain: automation

  input:
    # === CONFIGURATION PRINCIPALE ===
    thermostat_active:
      name: Activation du thermostat
      description: Input boolean pour activer/dÃ©sactiver le thermostat
      selector:
        entity:
          domain: input_boolean

    temperature_sensor:
      name: Capteur de tempÃ©rature
      description: Sonde de tempÃ©rature Ã  utiliser (externe au chauffage)
      selector:
        entity:
          domain: sensor
          device_class: temperature

    temperature_setpoint:
      name: Consigne de tempÃ©rature
      description: Input number avec la tempÃ©rature cible
      selector:
        entity:
          domain: input_number

    hysteresis:
      name: HystÃ©rÃ©sis
      description: Ã‰cart de tempÃ©rature pour Ã©viter les cycles rapides (0.5Â°C recommandÃ© pour radiateurs fonte)
      selector:
        number:
          min: 0.1
          max: 2.0
          step: 0.1
          unit_of_measurement: "Â°C"
      default: 0.5

    # === MODULE DE CHAUFFAGE ===
    module_type:
      name: Type de module chauffage
      description: "Climate: entitÃ© climate (Zigbee/Z-Wave/WiFi) | Select: entitÃ© select fil pilote (NodOn)"
      selector:
        select:
          options: ["Climate", "Select"]
      default: "Select"

    heating_entity_climate:
      name: EntitÃ© de chauffage (Climate)
      description: "SÃ©lectionner l'entitÃ© climate si type Climate"
      selector:
        entity:
          domain: climate
      default: ""

    heating_entity_select:
      name: EntitÃ© de chauffage (Select Fil Pilote)
      description: "SÃ©lectionner l'entitÃ© select fil pilote si type Select (NodOn)"
      selector:
        entity:
          domain: select
      default: ""

    heating_mode:
      name: Mode de chauffage actif
      description: Mode Ã  utiliser quand le chauffage doit Ãªtre actif
      selector:
        select:
          options: ["comfort","comfort-1","comfort-2","eco"]
      default: "comfort"

    # === INTÃ‰GRATION FENÃŠTRES/PORTES ===
    window_sensors:
      name: Capteurs de fenÃªtres (optionnel)
      description: Le thermostat se mettra en pause si fenÃªtre ouverte
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true
      default: []

    door_sensors:
      name: Capteurs de portes (optionnel)
      description: Le thermostat se mettra en pause si porte ouverte
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true
      default: []

    sensor_logic:
      name: Logique des capteurs
      description: "Normal: on=ouvert, off=fermÃ© | Inverse: on=fermÃ©, off=ouvert"
      selector:
        select:
          options: ["Normal","Inverse"]
      default: "Normal"

    # === NOTIFICATIONS & LOGS ===
    room_name:
      name: Nom de la piÃ¨ce
      description: Nom de la piÃ¨ce pour les logs
      selector:
        text: {}
      default: "PiÃ¨ce"

    log_entity:
      name: EntitÃ© de log (optionnel)
      description: input_text pour logger l'activitÃ©
      selector:
        entity:
          domain: input_text
      default: ""

    notify_devices:
      name: Appareils Ã  notifier (optionnel)
      description: Notifications sur mobile
      selector:
        device:
          integration: mobile_app
          multiple: true
      default: []

# ===== VARIABLES =====
variables:
  active: !input thermostat_active
  temp_sensor: !input temperature_sensor
  setpoint: !input temperature_setpoint
  hyst: !input hysteresis
  module_type: !input module_type
  heating_entity_climate: !input heating_entity_climate
  heating_entity_select: !input heating_entity_select
  heating_entity: >
    {{ heating_entity_climate if module_type == 'Climate' else heating_entity_select }}
  heating_mode: !input heating_mode
  windows: !input window_sensors
  doors: !input door_sensors
  logic: !input sensor_logic
  room: !input room_name
  log_ent: !input log_entity
  notify_devs: !input notify_devices
  
  # Ã‰tat des capteurs
  state_open: >
    {{ 'off' if logic == 'Inverse' else 'on' }}
  any_open: >
    {% set all_sensors = (windows | default([])) + (doors | default([])) %}
    {{ expand(all_sensors) | selectattr('state','eq', state_open) | list | length > 0 }}
  
  # TempÃ©rature actuelle et consigne
  current_temp: >
    {{ states(temp_sensor) | float(0) }}
  target_temp: >
    {{ states(setpoint) | float(19) }}
  
  # Mode actuel du chauffage
  current_mode: >
    {% if module_type == 'Select' %}
      {{ states(heating_entity) }}
    {% else %}
      {{ state_attr(heating_entity, 'preset_mode') }}
    {% endif %}
  
  # Mapper les modes pour NodOn (Select)
  heating_mode_mapped: >
    {% set mode = heating_mode %}
    {{ 'comfort_-1' if mode == 'comfort-1' else 
       'comfort_-2' if mode == 'comfort-2' else mode }}

# ===== TRIGGERS =====
trigger:
  # Changement tempÃ©rature
  - platform: state
    entity_id: !input temperature_sensor
    id: temp_change
  
  # Changement consigne
  - platform: state
    entity_id: !input temperature_setpoint
    id: setpoint_change
  
  # Activation/dÃ©sactivation
  - platform: state
    entity_id: !input thermostat_active
    id: active_change
  
  # FenÃªtres
  - platform: state
    entity_id: !input window_sensors
    id: window_change
  
  # Portes
  - platform: state
    entity_id: !input door_sensors
    id: door_change

# ===== CONDITIONS =====
condition: []

# ===== ACTIONS =====
action:
  - choose:
      # === THERMOSTAT DÃ‰SACTIVÃ‰ ===
      - conditions:
          - condition: template
            value_template: "{{ is_state(active, 'off') }}"
        sequence:
          # Si mode actif, couper le chauffage
          - choose:
              # MODULE SELECT (NodOn)
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Select' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "off"
              
              # MODULE CLIMATE
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Climate' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: "{{ heating_entity }}"
          
          # Log
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: "{{ now().strftime('%H:%M') }} - {{ room }}: Thermostat DÃ‰SACTIVÃ‰"

      # === FENÃŠTRE/PORTE OUVERTE ===
      - conditions:
          - condition: template
            value_template: "{{ is_state(active, 'on') }}"
          - condition: template
            value_template: "{{ any_open }}"
        sequence:
          # Couper le chauffage
          - choose:
              # MODULE SELECT (NodOn)
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Select' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ heating_entity }}"
                    data:
                      option: "off"
              
              # MODULE CLIMATE
              - conditions:
                  - condition: template
                    value_template: "{{ module_type == 'Climate' }}"
                  - condition: template
                    value_template: "{{ current_mode not in ['off', 'none'] }}"
                sequence:
                  - service: climate.turn_off
                    target:
                      entity_id: "{{ heating_entity }}"
          
          # Log
          - if:
              - condition: template
                value_template: "{{ log_ent != '' }}"
            then:
              - service: input_text.set_value
                target:
                  entity_id: "{{ log_ent }}"
                data:
                  value: "{{ now().strftime('%H:%M') }} - {{ room }}: Ouverture dÃ©tectÃ©e - Chauffage OFF"

      # === RÃ‰GULATION NORMALE ===
      - conditions:
          - condition: template
            value_template: "{{ is_state(active, 'on') }}"
          - condition: template
            value_template: "{{ not any_open }}"
        sequence:
          - choose:
              # TempÃ©rature TROP BASSE â†’ CHAUFFER
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp < (target_temp - hyst) }}"
                sequence:
                  # Activer le chauffage
                  - choose:
                      # MODULE SELECT (NodOn)
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Select' }}"
                          - condition: template
                            value_template: "{{ current_mode != heating_mode_mapped }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "{{ heating_mode_mapped }}"
                          
                          # Log
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: ðŸ”¥ Chauffage ON ({{ current_temp }}Â°C < {{ target_temp }}Â°C)
                      
                      # MODULE CLIMATE
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Climate' }}"
                          - condition: template
                            value_template: "{{ current_mode != heating_mode }}"
                        sequence:
                          - service: climate.turn_on
                            target:
                              entity_id: "{{ heating_entity }}"
                          - service: climate.set_preset_mode
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              preset_mode: "{{ heating_mode }}"
                          
                          # Log
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: ðŸ”¥ Chauffage ON ({{ current_temp }}Â°C < {{ target_temp }}Â°C)

              # TempÃ©rature TROP HAUTE â†’ COUPER
              - conditions:
                  - condition: template
                    value_template: "{{ current_temp > (target_temp + hyst) }}"
                sequence:
                  # Couper le chauffage
                  - choose:
                      # MODULE SELECT (NodOn)
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Select' }}"
                          - condition: template
                            value_template: "{{ current_mode not in ['off', 'none'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ heating_entity }}"
                            data:
                              option: "off"
                          
                          # Log
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: â„ï¸ Chauffage OFF ({{ current_temp }}Â°C > {{ target_temp }}Â°C)
                      
                      # MODULE CLIMATE
                      - conditions:
                          - condition: template
                            value_template: "{{ module_type == 'Climate' }}"
                          - condition: template
                            value_template: "{{ current_mode not in ['off', 'none'] }}"
                        sequence:
                          - service: climate.turn_off
                            target:
                              entity_id: "{{ heating_entity }}"
                          
                          # Log
                          - if:
                              - condition: template
                                value_template: "{{ log_ent != '' }}"
                            then:
                              - service: input_text.set_value
                                target:
                                  entity_id: "{{ log_ent }}"
                                data:
                                  value: >
                                    {{ now().strftime('%H:%M') }} - {{ room }}: â„ï¸ Chauffage OFF ({{ current_temp }}Â°C > {{ target_temp }}Â°C)

mode: queued
max: 10
```
